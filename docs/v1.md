# Pogadajmy ‚Äî Technical API Documentation

### Overview

**Pogadajmy** is a real-time chat platform built on ASP.NET Core 9 with SignalR for WebSocket communication, PostgreSQL for persistent storage, and Redis for caching and message backplane. It provides both REST API and WebSocket endpoints to support messaging, room management, authentication, and user presence.

---

## 1. Authentication & Authorization

**Base URL:** `/api/v1/auth`

### POST `/register`

Registers a new user.

```json
Request Body:
{
  "name": "mati",
  "password": "password123"
}
Response:
201 Created
{
  "id": "019a3c16-e454-71f5-bd4d-0c69ddc501bb",
  "name": "mati"
}
```

### POST `/login`

Authenticates a user and returns a JWT.

```json
Request Body:
{
  "name": "mati",
  "password": "password123"
}
Response:
200 OK
{
  "access_token": "<JWT_TOKEN>",
  "expires_in": 3600
}
```

**JWT** is required for all secured endpoints and must be passed in the `Authorization` header:

```
Authorization: Bearer <token>
```

---

## 2. Room Management

**Base URL:** `/api/v1/rooms`

### POST `/rooms`

Creates a new chat room.

```json
Request Body:
{
  "type": "group",
  "name": "Developers Room"
}
Response:
201 Created
{
  "id": "019a3c32-e584-7f78-929c-33f7e4a2d443",
  "type": "group",
  "name": "Developers Room"
}
```

### POST `/rooms/{id}/join`

Join a specific room.

```http
POST /api/v1/rooms/019a3c32-e584-7f78-929c-33f7e4a2d443/join
Authorization: Bearer <token>
204 No Content
```

### GET `/rooms/me`

Returns rooms that the current user belongs to.

```json
Response:
[
  {
    "id": "019a3c32-e584-7f78-929c-33f7e4a2d443",
    "name": "Developers Room",
    "type": "group"
  }
]
```

---

## 3. Messaging

**Base URL:** `/api/v1/rooms/{roomId}/messages`

### GET `/messages?take=50&before=...`

Returns paginated message history.

```json
Response:
[
  {
    "id": "019a3c99-bbc4-11f7-9a6b-03b8f1f91ab4",
    "userId": "019a3c16-e454-71f5-bd4d-0c69ddc501bb",
    "text": "Hello world!",
    "createdAt": "2025-10-31T21:10:52.696Z"
  }
]
```

### WebSocket (SignalR) `/hubs/chat`

SignalR hub endpoint for real-time events.

**Events (Server ‚Üí Client):**

* `Joined(user)` ‚Äî triggered when a user joins a room.
* `Left(user)` ‚Äî triggered when a user leaves.
* `Message(msg)` ‚Äî triggered when a message is sent.
* `Typing(user)` ‚Äî short-lived typing signal.

**Methods (Client ‚Üí Server):**

* `JoinRoom(roomId)`
* `LeaveRoom(roomId)`
* `SendMessage(roomId, text)`
* `TypingOn(roomId)` / `TypingOff(roomId)`

---

## 4. Direct Messages (DM)

**Base URL:** `/api/v1/dm`

### POST `/dm`

Creates or retrieves a private room between two users.

```json
Request Body:
{
  "userId": "019a3c77-bc4f-7a2b-8b1f-f6e4e5eac2c2"
}
Response:
{
  "roomId": "019a3d00-cc33-7182-bd4d-0c69ddc501aa",
  "userA": "019a3c16-e454-71f5-bd4d-0c69ddc501bb",
  "userB": "019a3c77-bc4f-7a2b-8b1f-f6e4e5eac2c2"
}
```

---

## 5. Presence & Typing

Redis maintains active users per room:

```
online:{roomId} -> set(userIds)
```

**Events:**

* User joins: added to Redis set.
* User leaves: removed from Redis set.
* Typing signals broadcast but not persisted.

---

## 6. Moderation

### Soft Delete (for messages)

```sql
ALTER TABLE messages ADD COLUMN is_deleted BOOLEAN DEFAULT FALSE;
ALTER TABLE messages ADD COLUMN deleted_by UUID NULL;
```

Endpoints:

* `DELETE /api/v1/messages/{id}` ‚Üí sets `is_deleted=true`.

---

## 7. Telemetry

All hub and REST interactions are logged via **Serilog** with enrichers:

* Request duration
* Connected user ID
* Hub error traces
* Message counts per user

Telemetry data is written to structured logs or Prometheus (optional exporter).

---

## 8. Deployment & Environment

### Required Environment Variables:

```
POGADAJMY_JWT_KEY=supersecretkey
POGADAJMY_JWT_ISSUER=pogadajmy
POGADAJMY_JWT_AUDIENCE=pogadajmy-api
ConnectionStrings__Default=Host=postgres;Port=5432;Database=pogadajmy;Username=postgres;Password=postgres
Redis__Configuration=redis:6379
```

### Docker Compose Example

```yaml
services:
  api:
    build: .
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      POGADAJMY_JWT_KEY: supersecretkey
      Redis__Configuration: redis:6379
    depends_on:
      - postgres
      - redis
  postgres:
    image: postgres:16-alpine
  redis:
    image: redis:7-alpine
```

---

## 9. Future Extensions

* Message reactions (üëç ‚ù§Ô∏è üî•)
* File sharing (S3-compatible storage)
* AI moderation / summarization
* Presence map and status updates
* Mobile-first UI (React Native)

---

**Version:** 1.0.0
**Author:** DalkeDev
**Date:** 2025-10-31
